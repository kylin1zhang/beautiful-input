# 流式转录功能设计文档

## 概述

本设计旨在解决 BeautifulInput 当前存在的核心问题：
1. **实时性差** - 本地模型耗资源，API 跨网延迟高
2. **无法流式转录** - 用户说完后才开始转录，体验不佳
3. **UI 反馈不足** - 缺少更好的状态提示
4. **无法修改已输入文字** - 输入后无法快速修正

## 设计决策

| # | 决策项 | 选择 |
|---|--------|------|
| 1 | 优先级 | 流式转录优先 |
| 2 | 服务模式 | 混合模式（云端优先，离线降级到本地） |
| 3 | 云端提供商 | 智谱、阿里云、讯飞、Groq 等让用户自选 |
| 4 | 本地方案 | FunASR（流式 ASR + VAD + 标点） |
| 5 | UI 展示 | 混合模式（录音时预览，结束后输入） |
| 6 | 预览消失方式 | 延迟 2 秒淡出 + "已输入"状态反馈 |
| 7 | 术语学习 | 自动学习 + 手动维护；ASR 热词 + AI 提示词 |
| 8 | 文字替换触发 | 与录音使用同一快捷键，自动检测选中状态 |
| 9 | 替换时 AI 处理 | 跟随全局设置 |

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      BeautifulInput                              │
│                     (Electron App)                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Renderer Layer                        │   │
│  │  ┌──────────┐  ┌──────────────┐  ┌──────────────────┐   │   │
│  │  │ FloatBall │  │ PreviewWindow │  │ Settings/TermMgr │   │   │
│  │  │ 悬浮球    │  │ 流式预览窗口  │  │ 设置/术语管理     │   │   │
│  │  └──────────┘  └──────────────┘  └──────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                         IPC 通信                                │
│                              │                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     Main Layer                           │   │
│  │  ┌──────────────────────────────────────────────────┐   │   │
│  │  │            Streaming ASR Manager                  │   │   │
│  │  │  ┌─────────────┐  ┌─────────────────────────┐    │   │   │
│  │  │  │ ASR Router  │  │ Provider Adapters       │    │   │   │
│  │  │  │ 路由器      │  │ 智谱/阿里云/讯飞/Groq/  │    │   │   │
│  │  │  │             │  │ FunASR 本地             │    │   │   │
│  │  │  └─────────────┘  └─────────────────────────┘    │   │   │
│  │  └──────────────────────────────────────────────────┘   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │   │
│  │  │ TermManager  │  │ AIProcessor  │  │ InputSimu-   │   │   │
│  │  │ 术语管理     │  │ AI 处理      │  │ lator 输入   │   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 服务提供商配置

| 类型 | 提供商 | 流式 | API 来源 | 备注 |
|------|--------|------|----------|------|
| 云端 | 智谱 GLM-4-Voice | ✅ | 国内 | 用户配置 API Key |
| 云端 | 阿里云 Paraformer | ✅ | 国内 | 用户配置 AccessKey |
| 云端 | 讯飞语音听写 | ✅ | 国内 | 用户配置 AppID/Key |
| 云端 | Groq Whisper | ✅ | 外网 | 用户配置 API Key |
| 本地 | FunASR | ✅ | 离线 | 内置，约 600MB |

### FunASR 本地方案详情

**模型文件**：
| 模型 | 用途 | 大小 | 必需？ |
|------|------|------|--------|
| `fsmn-vad` | 流式 VAD | ~1MB | ✅ 必需 |
| `paraformer-zh-streaming` | 流式语音识别 | ~220MB | ✅ 必需 |
| `ct-punc` | 标点恢复 | ~290MB | 推荐 |
| `fal-zh` | 时间戳预测 | ~38MB | 可选 |
| `itn-zh` | 数字/日期格式化 | ~50MB | 可选 |
| **总计** | | **~600MB** | |

**硬件要求**：
| 项目 | 最低要求 | 推荐配置 |
|------|----------|----------|
| CPU | 4核 | 8核+ |
| 内存 | 4GB | 8GB+ |
| 存储 | 1GB | 2GB+ |

**流式延迟**：约 600-900ms（从说话到显示文字）

## 流式转录工作流

```
┌─────────────────────────────────────────────────────────────────┐
│                     用户开始录音                                │
│                  （点击悬浮球 / 快捷键）                         │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 检测环境                                                    │
│     • 麦克风是否可用？                                          │
│     • 网络是否可用？（云端模式时）                               │
│     • 本地模型是否就绪？（离线模式时）                           │
└─────────────────────────────┬───────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  环境正常               │     │  环境异常               │
│  开始流式录音           │     │  显示错误提示           │
└───────────┬─────────────┘     │  • 无麦克风             │
            │                   │  • 网络不可用           │
            │                   │  • 模型未下载           │
            │                   └─────────────────────────┘
            ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 流式识别循环                                                │
│     ┌─────────┐    ┌─────────┐    ┌─────────┐                  │
│     │ 音频块  │ → │ ASR引擎 │ → │ 文字结果 │                  │
│     │ 600ms   │    │ 流式处理 │    │ 实时推送 │                  │
│     └─────────┘    └─────────┘    └─────────┘                  │
│                          ↓                                      │
│     ┌────────────────────────────────────────┐                 │
│     │ 预览窗口实时显示识别文字                 │                 │
│     │ "今天我想和大家聊一下关于..."            │                 │
│     └────────────────────────────────────────┘                 │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 用户停止录音 / VAD 自动停止                                 │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. AI 后处理（如果开启）                                       │
│     • 去除口语化                                                │
│     • 添加标点                                                  │
│     • 应用术语表                                                │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 输入到光标位置                                              │
│     • 显示 "已输入" 状态                                        │
│     • 2 秒后预览窗口淡出消失                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 预览窗口状态

| 状态 | 图标 | 显示内容 |
|------|------|----------|
| 录音中 | 🔴 | 实时滚动的识别文字 |
| 处理中 | ⏳ | 静态文字 + "AI 处理中..." |
| 已输入 | ✅ | 最终文字 + "已输入"（2秒后淡出） |
| 错误 | ❌ | 错误提示信息 |

## 智能输入/替换功能

统一快捷键，自动检测选中状态：

```
┌─────────────────────────────────────────────────────────────────┐
│                用户按下快捷键 / 点击悬浮球                       │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   检测是否有选中文本？                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  无选中文本             │     │  有选中文本             │
│  模式：新建输入         │     │  模式：替换选中         │
│  预览提示：无           │     │  预览提示："说出替换    │
│                        │     │           内容..."      │
└───────────┬─────────────┘     └───────────┬─────────────┘
            │                               │
            └───────────────┬───────────────┘
                            │
                            ▼
              ┌─────────────────────────────┐
              │  开始流式录音 + 实时识别     │
              └───────────────┬─────────────┘
                              │
                              ▼
              ┌─────────────────────────────┐
              │  录音结束 + AI 处理          │
              └───────────────┬─────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│  新建输入模式           │     │  替换选中模式           │
│  输入到光标位置         │     │  替换选中的文字         │
└─────────────────────────┘     └─────────────────────────┘
```

## 术语学习功能

### 自动学习流程

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   识别错误    │    │   用户修正    │    │   记录术语    │
│  "杰米尼"     │ →  │ 改为 Gemini   │ →  │ 添加到词库    │
└──────────────┘    └──────────────┘    └──────────────┘
```

### 术语使用

- **ASR 热词**：传递给语音识别模型（FunASR 支持 WFST 热词）
- **AI 提示词**：在 AI 处理时告诉模型"用户经常说这些词，请正确识别"

### 术语数据结构

```typescript
interface Term {
  id: string;
  term: string;        // 正确术语，如 "Gemini"
  aliases: string[];   // 常见误读，如 ["杰米尼", "吉米尼"]
  source: 'auto' | 'manual';  // 来源：自动学习 / 手动添加
  usageCount: number;  // 使用次数（用于排序）
  createdAt: Date;
  updatedAt: Date;
}
```

## 模块架构

```
src/main/modules/
├── streaming-asr/           # 新增：流式 ASR 管理模块
│   ├── index.ts             # 模块入口
│   ├── router.ts            # ASR 提供商路由
│   ├── providers/           # 各提供商适配器
│   │   ├── base.ts          # 基类接口
│   │   ├── zhipu.ts         # 智谱 GLM-4-Voice
│   │   ├── aliyun.ts        # 阿里云 Paraformer
│   │   ├── xunfei.ts        # 讯飞语音听写
│   │   ├── groq.ts          # Groq Whisper
│   │   └── funasr.ts        # FunASR 本地
│   └── types.ts             # 类型定义
│
├── term-manager/            # 新增：术语管理模块
│   ├── index.ts             # 模块入口
│   ├── store.ts             # 术语存储
│   ├── learner.ts           # 自动学习逻辑
│   └── types.ts             # 类型定义
│
├── preview-window/          # 新增：预览窗口模块
│   ├── index.ts             # 窗口管理
│   └── types.ts             # 类型定义
│
├── recording/               # 现有：需要改造
│   └── ...                  # 支持流式音频输出
│
├── ai-processor/            # 现有：需要改造
│   └── ...                  # 支持术语提示词
│
└── input-simulator/         # 现有：需要改造
    └── ...                  # 支持替换选中文本
```

## 新增 IPC 通道

```typescript
// src/shared/types/index.ts

enum IpcChannels {
  // ... 现有通道 ...

  // 流式 ASR
  STREAMING_ASR_START: 'streaming-asr:start',
  STREAMING_ASR_STOP: 'streaming-asr:stop',
  STREAMING_ASR_TEXT: 'streaming-asr:text',        // 实时文字推送
  STREAMING_ASR_ERROR: 'streaming-asr:error',

  // 预览窗口
  PREVIEW_SHOW: 'preview:show',
  PREVIEW_UPDATE: 'preview:update',
  PREVIEW_HIDE: 'preview:hide',
  PREVIEW_SET_STATUS: 'preview:set-status',

  // 术语管理
  TERM_LIST: 'term:list',
  TERM_ADD: 'term:add',
  TERM_UPDATE: 'term:update',
  TERM_DELETE: 'term:delete',
  TERM_LEARN: 'term:learn',    // 自动学习

  // 文字替换
  REPLACE_SELECTED: 'replace:selected',
  GET_SELECTED_TEXT: 'get:selected-text',
}
```

## 设置界面更新

```
┌─────────────────────────────────────────────────────────────────┐
│  设置                                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🎤 语音识别                                                    │
│  ├── 识别模式：[云端优先 ▼]  （云端优先 / 离线优先 / 仅离线）   │
│  ├── 云端服务：[阿里云 Paraformer ▼]                           │
│  │   └── 管理 API Key...                                       │
│  └── 离线模型：已下载 (FunASR 600MB)  [重新下载]               │
│                                                                 │
│  📝 术语管理                                                    │
│  ├── 启用自动学习：[✓]                                         │
│  └── 管理术语... → 打开术语管理页面                            │
│                                                                 │
│  ⌨️ 快捷键                                                      │
│  ├── 开始录音/替换选中：Alt+Shift+O  [修改]                    │
│  │   └── 无选中时输入，有选中时替换                            │
│  └── 快速翻译：Alt+Shift+T           [修改]                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 打包体积与性能影响

| 项目 | 现有 | 新增后 | 变化 |
|------|------|--------|------|
| **安装包体积** | ~200MB | ~800MB | +600MB（FunASR 模型） |
| **运行内存** | 100-300MB | 200-500MB | +100-200MB（FunASR 运行时） |
| **首屏启动** | 即时 | 即时 | 无变化（FunASR 按需启动） |
| **流式延迟** | N/A | 600-900ms | 新增能力 |

### 优化策略

- FunASR 模型可选下载（用户选择"离线模式"时才下载）
- 云端模式零额外体积
- 本地模型按需启动，不占用常驻内存

## UI 反馈场景

| 场景 | 反馈方式 |
|------|----------|
| 没有检测到麦克风 | 弹窗提示 + 设置中显示"未检测到麦克风" |
| 麦克风被其他程序占用 | 录音开始时提示"麦克风不可用" |
| 网络不可用（云端模式） | 提示"网络不可用，已切换到离线模式" |
| 本地模型未下载 | 提示"请先下载离线模型"或自动下载 |

## 实施阶段

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| **P0** | 流式 ASR 框架 + 单个云端提供商（阿里云） | 核心 |
| **P0** | 预览窗口 + 流式文字展示 | 核心 |
| **P1** | FunASR 本地集成 | 重要 |
| **P1** | 术语管理（自动学习 + 手动维护） | 重要 |
| **P1** | 文字替换功能（统一快捷键） | 重要 |
| **P2** | 更多云端提供商（智谱、讯飞、Groq） | 增强 |
| **P2** | UI 反馈优化（麦克风检测、网络状态） | 增强 |
